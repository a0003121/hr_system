<!DOCTYPE html>
<html>

<head>
	<meta charset="UTF-8">
	<title>請假資料</title>
	<link rel="stylesheet" href="vendors/tablesort-5.3.0/tablesort.css">
	<link rel="stylesheet" href="/vendors/datetimepicker/bootstrap-datetimepicker.min.css">
	<style>
		button.delete,
		button.update {
			margin-right: 5px;
		}

		div.popup_content button {
			margin-right: 10px;
		}
	</style>
</head>

<body>
	<div id="header"></div>
	<h2 style="padding: 10px;">請假資料</h2>
	<main>
		<button class="btn btn-outline-primary" onclick="newLeave()">新增</button>

		<table class="table table-hover" id="table">
			<thead>
				<tr>
					<th></th>
					<th>員工編號</th>
					<th>部門</th>
					<th>姓名</th>
					<th>假別</th>
					<th>開始日期</th>
					<th>結束日期</th>
					<th>時數</th>
					<td></td>
				</tr>
			</thead>
			<tbody id="leave_list"></tbody>
		</table>
	</main>


	<div class="popup_bg" id="new_pop" style="display: none">
		<div class="popup_content">
			<div class="input-group mb-3 col">
				<span class="input-group-text">員工編號/姓名</span>
				<input class="form-control" list="datalistOptions" name="new_empNo" placeholder="請選擇">
				<datalist id="datalistOptions"></datalist>
			</div>

			<div class="input-group mb-3 col">
				<span class="input-group-text">開始日期</span>
				<input type="text" class="form-control" name="new_startDate">
			</div>
			<div class="input-group mb-3 col">
				<span class="input-group-text">結束日期</span>
				<input type="text" class="form-control" name="new_endDate">
			</div>

			<div class="row">
				<div class="input-group mb-3 col">
					<span class="input-group-text">假別</span>
					<select class="form-select" name="type"></select>
				</div>
				<div class="input-group mb-3 col">
					<span class="input-group-text">時數</span>
					<input class="form-control" name="day" disabled>
				</div>
			</div>
			<button class="update btn btn-outline-primary float-end newBtn" id="new_cancel">取消</button>
			<button class="update btn btn-outline-primary float-end newBtn" id="new_confirm">確定</button>
		</div>

	</div>

	<div class="popup_bg" id="update_pop" style="display: none">
		<div class="popup_content">
			<div class="input-group mb-3 col">
				<span class="input-group-text">員工編號/姓名</span>
				<input class="form-control" disabled id="update_name">
			</div>

			<div class="input-group mb-3 col">
				<span class="input-group-text">開始日期</span>
				<input type="text" class="form-control" name="update_startDate">
			</div>
			<div class="input-group mb-3 col">
				<span class="input-group-text">結束日期</span>
				<input type="text" class="form-control" name="update_endDate">
			</div>

			<div class="row">
				<div class="input-group mb-3 col">
					<span class="input-group-text">假別</span>
					<select class="form-select" name="update_type"></select>
				</div>
				<div class="input-group mb-3 col">
					<span class="input-group-text">時數</span>
					<input class="form-control" name="update_day" disabled>
				</div>
			</div>
			<button class="update btn btn-outline-primary float-end newBtn" id="update_cancel">取消</button>
			<button class="update btn btn-outline-primary float-end newBtn" id="update_confirm">確定</button>
		</div>

	</div>



	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
	<script src="//cdn.jsdelivr.net/npm/sweetalert2@11"></script>
	<script src='vendors\tablesort-5.3.0\tablesort.js'></script>
	<script src="/vendors/datetimepicker/bootstrap-datetimepicker.js"></script>
	<!--https://www.bootcss.com/p/bootstrap-datetimepicker/-->
	<script src="/vendors/datetimepicker/bootstrap-datetimepicker.zh-TW.js"></script>
	<script src="public/util.js"></script>
	<script>
		var employee_list = {};
		var temp_id;
		$("#header").load("/backheader");
		$(function () {

			$('input[name="new_startDate"], input[name="new_endDate"], input[name="update_startDate"], input[name="update_endDate"]').datetimepicker({
				language: 'zh-TW',//顯示中文
				format: 'yyyy-mm-dd hh:ii',//顯示格式
				initialDate: new Date(),//初始化當前日期
				autoclose: true,//選中自動關閉
			});

			$('input[name="new_startDate"], input[name="new_endDate"]')
				.datetimepicker()
				.on('changeDate', function (ev) {
					$('input[name="new_startDate"]').data("datetimepicker").getDate();
					$('input[name="new_endDate"]').data("datetimepicker").getDate();
				});

			$('input[name="update_startDate"], input[name="update_endDate"]')
				.datetimepicker()
				.on('changeDate', function (ev) {
					$('input[name="update_startDate"]').data("datetimepicker").getDate();
					$('input[name="update_endDate"]').data("datetimepicker").getDate();
				});


			$("th.prev>span.glyphicon").addClass('fas fa-arrow-left');
			$("th.next>span.glyphicon").addClass('fas fa-arrow-right');
			//取得員工資料
			$.ajax({
				url: "http://localhost:8080/employees",
				type: "GET",
				async: false,
				dataType: "json",
				success: function (data) {
					for (item in data) {
						$("datalist#datalistOptions").append(`<option>${data[item]["empNo"]} &nbsp;${data[item]["name"]}</option>`);
						employee_list[data[item]["empNo"]] = data[item];
					}
					console.log(employee_list);
				}
			});

			//取得請假資料
			getLeaveData();

			//取得假別
			$.ajax({
				url: "http://localhost:8080/leaves",
				type: "GET",
				async: false,
				dataType: "json",
				success: function (data) {
					for (index in data) {
						$("select[name='type']").append(`<option value=${data[index]["id"]}>${data[index]["name"]}</option`);
						$("select[name='update_type']").append(`<option value=${data[index]["id"]}>${data[index]["name"]}</option`);
					}
				}
			});

			//選取員工
			$("input[name='new_empNo']").on("change", function () {
				temp_id = $(this).val().substring(0, $(this).val().indexOf(" "));
			});

			$("#new_cancel,#update_cancel, .popup_bg").on("click", function () {
				$("div.popup_bg").hide();
			});
			$("#new_confirm").on("click", function () {
				$.ajax({
					url: "http://localhost:8080/employeeLeave",
					type: "POST",
					data: {
						"employeeId": temp_id,
						"leaveId": $("select[name='type'] option:selected").val(),
						"hours": $("input[name='day']").val(),
						"startTime": Date.parse($("input[name='new_startDate']").val()),
						"endTime": Date.parse($("input[name='new_endDate']").val()),
						"_csrf": csrf()
					},
					dataType: "json",
					success: function (data) {
						console.log(data);
						if (data["id"] != null) {
							let startDate = data["startTime"].split('.')[0];
							let endDate = data["endTime"].split('.')[0];
							let empNo = data["employeeId"];
							let html = `<tr>
									<td></td>
									<td>${empNo}</td>
									<td>${employee_list[empNo]["deptName"]["name"]}</td>
									<td>${employee_list[empNo]["name"]}</td>
									<td>${$("select[name='update_type'] option[value='"+data["leaveId"]+"']").text()}</td>
									<td>${startDate}</td>
									<td>${endDate}</td>
									<td>${data["hours"]}</td>
									<td>
										<button class="delete btn btn-outline-primary float-end" data-id="${data["id"]}"><i class="fas fa-trash-alt"></i></button>
										<button class="update btn btn-outline-primary float-end" data-id="${data["id"]}"><i class="fas fa-edit"></i></button>
									</td>
								</tr>`;
								
							$("#leave_list").prepend(html);
							Swal.fire({
								icon: 'success',
								title: '新增成功!',
								text: '',
								timer: 2000
							})
							$("div.popup_bg").hide();
						}
					}
				});
			});

			$(".popup_content").on("click", function (e) {
				e.stopPropagation();
			})

			$("input[name='new_endDate'], input[name='new_startDate']").on("change", function () {

				let start = Date.parse($("input[name='new_startDate']").val());
				let end = Date.parse($("input[name='new_endDate']").val());

				if (start > end) {
					$("input[name='day']").val("開始時間需大於結束時間!");
					$("input[name='day']").css("color", "red");
				} else {
					$("input[name='day']").css("color", "black");
				}

				//取得假別
				$.ajax({
					url: "http://localhost:8080/leaveDays",
					type: "GET",
					dataType: "json",
					data: { "startTime": start, "endTime": end },
					success: function (data) {
						$("input[name='day']").val(data);
					}
				});
			});


			//https://tristen.ca/tablesort/demo/
			new Tablesort(document.getElementById('table'));



			//修改資料
			$("#leave_list").on("click", "button.update", function () {
				$("#update_pop").show();
				$.ajax({
					url: "http://localhost:8080/employeeLeave",
					type: "GET",
					data: { "id": $(this).attr("data-id") },
					dataType: "json",
					success: function (data) {
						console.log(data);
						temp_id = data["id"];
						$("#update_name").val(data["employeeId"] + " " + employee_list[data["employeeId"]]["name"]);
						$("input[name='update_startDate']").val(data["startTime"].substring(0, 16));
						$("input[name='update_endDate']").val(data["endTime"].substring(0, 16));
						$("input[name='update_day']").val(data["hours"]);
						$("select[name='update_type'] option").attr("selected", false);
						$("select[name='update_type'] option[value='" + data["leaveId"] + "']").attr("selected", true);
					}
				});

			});

			$("#update_confirm").on("click", function(){
				$.ajax({
					url: "http://localhost:8080/employeeLeave",
					type: "PUT",
					data: {
						"id": temp_id,
						"leaveId": $("select[name='update_type'] option:selected").val(),
						"hours": $("input[name='update_day']").val(),
						"startTime": Date.parse($("input[name='update_startDate']").val()),
						"endTime": Date.parse($("input[name='update_endDate']").val()),
						"_csrf": csrf()
					},
					dataType: "json",
					success: function (data) {
						console.log(data);
						if (data["id"] != null) {
							Swal.fire({
								icon: 'success',
								title: '修改成功!',
								text: '',
								timer: 2000
							});
							getLeaveData();
							$("div.popup_bg").hide();
						}
					}
				});
			})
			$("input[name='update_endDate'], input[name='update_startDate']").on("change", function () {

				let start = Date.parse($("input[name='update_startDate']").val());
				let end = Date.parse($("input[name='update_endDate']").val());

				if (start > end) {
					$("input[name='update_day']").val("開始時間需大於結束時間!");
					$("input[name='update_day']").css("color", "red");
				} else {
					$("input[name='update_day']").css("color", "black");
				}

				//取得假別
				$.ajax({
					url: "http://localhost:8080/leaveDays",
					type: "GET",
					dataType: "json",
					data: { "startTime": start, "endTime": end },
					success: function (data) {
						$("input[name='update_day']").val(data);
					}
				});
			});
			//刪除資料
			$("#leave_list").on("click", "button.delete", function () {
				let that = $(this);

				swal.fire({
					title: '確定刪除?',
					text: "",
					icon: 'warning',
					showCancelButton: true,
					cancelButtonText: '取消',
					confirmButtonText: '確定'
				}).then((result) => {
					if (result.isConfirmed) {
						$.ajax({
							url: "http://localhost:8080/employeeLeaves",
							type: "DELETE",
							data: {
								"id": $(this).attr("data-id"),
								"_csrf": csrf()
							},
							dataType: "json",
							success: function (data) {
								$(that).parent().parent().remove();
								Swal.fire({
									icon: 'success',
									title: '刪除成功!',
									text: '',
									timer: 2000
								})
							}
						});
					}
				})

			});
		});




		//新增按鈕
		function newLeave() {
			$("#new_pop").show();
			$("input[name='new_startDate']").val(new Date().toISOString().split('T')[0] + " 09:00");
			$("input[name='new_endDate']").val(new Date().toISOString().split('T')[0] + " 18:00");
			$("input[name='day']").val("8");
		}

		//取得所有資料
		function getLeaveData() {
			$.ajax({
				url: "http://localhost:8080/employeeLeaves",
				type: "GET",
				async: false,
				dataType: "json",
				success: function (data) {
					console.log(data);
					$("#leave_list").html("");
					let html = "";
					for (item in data) {
						let startDate = data[item]["startTime"].split('.')[0];
						let endDate = data[item]["endTime"].split('.')[0];
						let empNo = data[item]["employeeId"];
						html += `<tr>
									<td></td>
									<td>${empNo}</td>
									<td>${employee_list[empNo]["deptName"]["name"]}</td>
									<td>${employee_list[empNo]["name"]}</td>
									<td>${data[item]["leave"]["name"]}</td>
									<td>${startDate}</td>
									<td>${endDate}</td>
									<td>${data[item]["hours"]}</td>
									<td>
										<button class="delete btn btn-outline-primary float-end" data-id="${data[item]["id"]}"><i class="fas fa-trash-alt"></i></button>
										<button class="update btn btn-outline-primary float-end" data-id="${data[item]["id"]}"><i class="fas fa-edit"></i></button>
									</td>
								</tr>`;
					}
					$("#leave_list").append(html);
				}
			});
			
		}



	</script>
</body>

</html>